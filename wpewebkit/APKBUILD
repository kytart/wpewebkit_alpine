# Maintainer: signageOS <dev@signageos.io>
# Maintainer: Andrii Guriev <bearrailgun@gmail.com>
pkgname=wpewebkit
pkgver=2.25.1
pkgrel=0
pkgdesc="Portable web rendering engine WPEWebKit"
url="https://wpewebkit.org/"
arch="armhf armv7"
license="custom"
makedepends="
	cmake
	ninja
	perl
	ruby
	cairo-dev
	icu-dev
	jpeg-dev
	libepoxy-dev
	libgcrypt-dev
	libsoup-dev
	libwebp-dev
	atk-dev
	harfbuzz-dev
	at-spi2-atk-dev
	openjpeg-dev
	openjpeg-tools
	woff2-dev
	libtasn1-dev
	libxslt-dev
	bubblewrap
	libseccomp-dev
	xdg-dbus-proxy
	gstreamer-dev
	gst-plugins-base-dev
	gst-plugins-bad-dev
	gperf
	hyphen-dev
	libjpeg-turbo-dev
	libnotify-dev
	libpng-dev
	libsecret-dev
	libxml2-dev
	libxt-dev
	mesa-dev
	pango-dev
	paxmark
	python2
	sqlite-dev
	libxkbcommon-dev
	wayland-dev
	"
replaces="webkit"
options="!check" # upstream doesn't package them in release tarballs: Tools/Scripts/run-gtk-tests: Command not found
source="https://wpewebkit.org/releases/${pkgname}-${pkgver}.tar.xz
	fix-openjpeg.patch
	"
builddir="$srcdir/wpewebkit-$pkgver"

build() {
	local _archopt=
	case "$CARCH" in
		# disable _FORTIFY_SOURCE to work around:
		# cc1plus: out of memory allocating 65536 bytes after a total of 3131101184 bytes
		x86) CXXFLAGS="$CXXFLAGS -U_FORTIFY_SOURCE";;
		armhf|armv7|ppc64le|s390x) _archopt="-DENABLE_JIT=OFF";;
	esac

	# reduce memory usage on 32 bit
	# https://bugs.webkit.org/show_bug.cgi?id=199272
	export CXXFLAGS="$CXXFLAGS -g0"
	export LDFLAGS="$LDFLAGS -lintl"

	mkdir build
	cd build
	cmake -GNinja \
		-DPORT=WPE \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DWPE_INCLUDE_DIRS=/usr/include/wpe-1.0 \
		-DWPEBACKEND_FDO_INCLUDE_DIRS=/usr/include/wpe-fdo-1.0 \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DLIB_INSTALL_DIR=/usr/lib \
		-DENABLE_GEOLOCATION=OFF \
		-DENABLE_SAMPLING_PROFILER=OFF \
		-DENABLE_MINIBROWSER=ON \
		-DUSE_WOFF2=OFF \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
		-DCMAKE_LD_FLAGS="$LDFLAGS" \
		$_archopt \
		..
	# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=923476
	# ninja JavaScriptCore-4-gir
	ninja -j4
}

check() {
	ninja -C "$builddir"/build check
}

package() {
	DESTDIR="$pkgdir" ninja -C "$builddir"/build install
	# needed for JIT
	# XXX - check paxmark
	#paxmark -m "$pkgdir"/usr/libexec/webkit2gtk-4.0/WebKitWebProcess
}

sha512sums="0b416b164cc9547a974e47be1b43658083642f93970a66f003676154e4c980ef0cbc6533f70e3f6de5b4d128da12cf9ef1717e7de270bd83bb87142ea9720c3c  wpewebkit-2.25.1.tar.xz
c517c012f5630ef6be5be7d9592c5e042a070f849a141859edefa7984acb98dbd0d718fe6613cd35ba3b7d8530beebcc7408fd077cd914ed335c5e524e9e746a  fix-openjpeg.patch"
